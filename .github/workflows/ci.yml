name: CI

on:
  push:
    tags: ['v*']
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-build:
    runs-on: ${{ matrix.os }}
    env:
      CONDA_ENVS_PATH: ${{ temp }}/conda-envs
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: [3.9, 3.10, 3.11, 3.12]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Determine cache key source
        id: key
        run: |
          python - <<'PY'
          import hashlib,sys,pathlib
          for fname in ('conda-lock.yml','environment.yml'):
              p=pathlib.Path(fname)
              if p.exists():
                  h=hashlib.sha256(p.read_bytes()).hexdigest()
                  print('::set-output name=keyhash::'+h)
                  sys.exit(0)
          print('::set-output name=keyhash::none')
          PY

      - name: Restore conda env tarball cache
        id: conda-env-cache
        uses: actions/cache@v4
        with:
          path: ./.cache/conda-envs
          key: conda-env-${{ matrix.os }}-py${{ matrix.python-version }}-${{ steps.key.outputs.keyhash }}
          restore-keys: |
            conda-env-${{ matrix.os }}-py${{ matrix.python-version }}-
            conda-env-${{ matrix.os }}-

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: ${{ matrix.python-version }}
          environment-file: ''
          use-mamba: true

      - name: Install conda-lock (for deterministic installs)
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install conda-lock

      - name: Create or restore prefix conda env and install conda-forge packages
        shell: bash -l {0}
        run: |
          mkdir -p ./.cache/conda-envs
          mkdir -p "$CONDA_ENVS_PATH"
          if [ -f ./.cache/conda-envs/testenv.tar.gz ]; then
            echo "Found cached env tarball, extracting to $CONDA_ENVS_PATH"
            tar -xzf ./.cache/conda-envs/testenv.tar.gz -C "$CONDA_ENVS_PATH"
            echo "Attempting conda-unpack to make the env relocatable"
            "$CONDA_ENVS_PATH/testenv/bin/conda-unpack" || true
          else
            echo "No cached env; creating prefix env"
            # Prefer locked installs if a lockfile exists
            if [ -f conda-lock.yml ]; then
              echo "Using conda-lock.yml to install pinned environment"
              case "$RUNNER_OS" in
                Linux) platform=linux-64 ;;
                macOS) platform=osx-64 ;;
                Windows) platform=win-64 ;;
                *) platform=linux-64 ;;
              esac
              conda-lock install --file conda-lock.yml --platform $platform -p "$CONDA_ENVS_PATH/testenv" || true
            else
              echo "conda-lock.yml not found; falling back to environment.yml"
              mamba env create -p "$CONDA_ENVS_PATH/testenv" -f environment.yml || true
              mamba install -p "$CONDA_ENVS_PATH/testenv" -c conda-forge -y rdkit openbabel numpy dimorphite-dl conda-pack || true
            fi
            echo "Packing env to ./.cache/conda-envs/testenv.tar.gz"
            "$CONDA_ENVS_PATH/testenv/bin/conda-pack" -o ./.cache/conda-envs/testenv.tar.gz || true
          fi

      - name: Install editable package and dev deps
        shell: bash -l {0}
        run: |
          conda run -p "$CONDA_ENVS_PATH/testenv" python -m pip install --upgrade pip build setuptools wheel
          conda run -p "$CONDA_ENVS_PATH/testenv" python -m pip install -e '.[dev]'

      - name: Run tests
        shell: bash -l {0}
        run: |
          conda run -p "$CONDA_ENVS_PATH/testenv" python -m pytest -q

      - name: Build artifacts
        shell: bash -l {0}
        run: |
          conda run -p "$CONDA_ENVS_PATH/testenv" python -m pip install --upgrade build
          conda run -p "$CONDA_ENVS_PATH/testenv" python -m build --sdist --wheel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*
