name: Generate conda-lock

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  generate-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install conda-lock
        run: |
          python -m pip install --upgrade pip
          pip install conda-lock


    - name: Generate conda-lock.yml for multiple platforms
      run: |
    # create lockfile for linux/osx/windows (conda-lock v2+ supports multiple platforms)
    conda-lock -f environment.yml --platform linux-64 --platform osx-64 --platform win-64 --filename conda-lock.yml

      - name: Create pull request with updated conda-lock.yml
        id: create_pr
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update conda-lock.yml"
          branch: conda-lock/update-${{ github.run_number }}
          title: "chore: update conda-lock.yml"
          body: |
            This PR updates the generated conda-lock.yml via GitHub Actions.
            Please review and merge to keep lockfile up to date.
          labels: "chore, conda-lock, automerge"

      - name: Wait for minimum successful checks on PR head
        id: wait_checks
        if: steps.create_pr.outputs['pull-request-number'] != ''
        shell: bash
        run: |
          set -eo pipefail
          sha="${{ steps.create_pr.outputs['pull-request-head-sha'] }}"
          min_success=2
          interval=30
          timeout=$((30*60))
          elapsed=0
          echo "Waiting up to $((timeout/60)) minutes for at least $min_success successful check runs on commit $sha"
          while [ $elapsed -lt $timeout ]; do
            response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/commits/$sha/check-runs")
            successes=$(echo "$response" | python -c 'import sys,json; j=json.load(sys.stdin); print(sum(1 for r in j.get("check_runs",[]) if r.get("conclusion")=="success"))')
            echo "Successful checks: $successes"
            if [ "$successes" -ge "$min_success" ]; then
              echo "Condition met: $successes >= $min_success"
              exit 0
            fi
            sleep $interval
            elapsed=$((elapsed+interval))
          done
          echo "Timeout waiting for required successful checks ($min_success) on $sha"
          exit 1

      - name: Enable auto-merge for the PR
        if: steps.wait_checks.conclusion == 'success' && steps.create_pr.outputs['pull-request-number'] != ''
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          pull-request-number: ${{ steps.create_pr.outputs['pull-request-number'] }}
          merge-method: merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
